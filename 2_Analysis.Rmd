---
title: "2_Analysis"
author: "Sofie McComb"
date: "10/17/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This script will analyze the results of the Circuitscape and Linkage Mapper Runs. Visualizations of the results will be created in ArcGIS.
The GIS file where the runs were completed is Data/2_Analysis/Circuitscape/KitFox_RunAnalyses.mxd folder. KitFoxCoreAreas.mxd was used in the creation of Western Kern core areas. KitFox_CompareOutputs.mxd is just a quick check of different analysis outputs. Paper_Maps has the visualizations of results with the mxd used to make the pngs and some of the calculations that were completed to create the maps.

##Circuitscape
The ArcGIS Circuitscape toolbox (Circuitscape_for_ArcGIS_2013_10_08_rev2) was used to run the analyses. For Circuitscape, an ASCII file of the Kit Fox core area shapefile data was created using the focal area to raster tool in the Circuitscape toolbox (works better than creating ASCII in R). These are saved in the Data/1_DataProcessing/CoreArea folder for each year (ASCII created using each separate year resistance ASCII layer). Circuitscape was run for each resistance layer with each matching core area ASCII file. Ran pairwise analysis for cumulative current, and other settings standard.

Toolbox and results from the run saved in folder above the R project, and run on local drive where possible, for better processing.


##Linkage Mapper
The ArcGIS Linkage Mapper toolbox (Linkage_Mapper_2_0_0) was used to run the linkage mapper analyses. For Linkage Mapper, the resistance rasters and the kit fox core area shapefiles were used. For settings, dropped corridors that intersect core areas and truncated corridors at 200 km.

Toolbox and results from the run saved in folder above the R project, and run on local drive where possible, for better processing.


##Pinchpoint Mapper
For Pinchpoint Mapper, ran on linkage mapper output with same core areas shapefile and resistance ASC used. For settings, used CWD cutoff distance of 200 km, and calculated adjacent pair pinch points using Circuitscape.



##Read Packages
```{r}

library(sf)
library(raster)
library(tidyverse)
library(ggplot2)
library(purrr)
library(estimatr)
library(reshape2)
# library(coin)
# library(pwr)
# library(WRS2)
# library(broom)

options(scipen = 999)

```

#Create csv dataframe from LCP Circuitscape outputs

```{r}

#Read in Least Cost Paths from Circuitscape/Linkage Mapper Runs
  #Originally run on local drive and moved into main project folder (not R project as very large)
  #Will need to change destinations to wherever files are stored using files below
files<-"Z:/FallowFox/ConnectivityTools/Results/Revisions/"

LCP_2011 <- sf::st_read(paste0(files, "KF_2011/output/link_maps.gdb"), layer = "KF_2011_LCPs") %>% 
  st_set_geometry(NULL)
LCP_2015 <- sf::st_read(paste0(files, "KF_2015/output/link_maps.gdb"), layer = "KF_2015_LCPs") %>% 
  st_set_geometry(NULL)
LCP_2017 <- sf::st_read(paste0(files, "KF_2017/output/link_maps.gdb"), layer = "KF_2017_LCPs") %>% 
  st_set_geometry(NULL)

#Create and save dataframes for three years
LCP_2011_csv<-LCP_2011%>% dplyr::mutate(Year=2011) %>% select(Year, everything())
LCP_2015_csv<-LCP_2015%>% dplyr::mutate(Year=2015)%>% select(Year, everything())
LCP_2017_csv<-LCP_2017%>% dplyr::mutate(Year=2017)%>% select(Year, everything())
write_csv(LCP_2011_csv, "Data/2_Analysis/LCP_CSV/LCP_2011_csv.csv")
write_csv(LCP_2015_csv, "Data/2_Analysis/LCP_CSV/LCP_2015_csv.csv")
write_csv(LCP_2017_csv, "Data/2_Analysis/LCP_CSV/LCP_2017_csv.csv")


```

### Organize into one dataframe
```{r packages_and_data}
# rm(list=ls())


df_2011 <- read_csv("./Data/2_Analysis/LCP_CSV/LCP_2011_csv.csv")
df_2015 <- read_csv("./Data/2_Analysis/LCP_CSV/LCP_2015_csv.csv")
df_2017 <- read_csv("./Data/2_Analysis/LCP_CSV/LCP_2017_csv.csv")


df_reg <- rbind(df_2011, df_2015, df_2017)

# Create to_from factor variable column
df_reg$From_To <- as.factor(paste0(df_reg$From_Core,"_",df_reg$To_Core))
df_reg$Year <- as.factor(df_reg$Year)

# Convert meters to KM
df_reg$CW_Dist_km <- df_reg$CW_Dist/1000
df_reg$LCP_Length_km <- df_reg$LCP_Length/1000
df_reg$Euc_Dist_km <- df_reg$Euc_Dist/1000

```

###Summarizations

```{r}

df_reg %>% group_by(Year) %>% summarize(LCP=n(),
                                        CWDmean=mean(CW_Dist_km),
                                        CWDsd=sd(CW_Dist_km),
                                        LCPLengthmean=mean(LCP_Length_km),
                                       LCPLengthsd=sd(LCP_Length_km),
                                        CWDLCPmean=mean(cwd_to_Path_Length_Ratio),
                                        CWDLCPsd=sd(cwd_to_Path_Length_Ratio),
                                      ERmean=mean(Effective_Resistance),
                                        ERsd=sd(Effective_Resistance))


```


### Within estimator regression
```{r withinReg}

###### LCP Length ######
# Reference year: 2011
lcp_length_km_lmrob <- estimatr::lm_robust(formula = LCP_Length_km ~ Year,
          data = df_reg,
          clusters = From_To,
          fixed_effects = ~From_To,
          se_type = 'stata')
summary(lcp_length_km_lmrob)

# Reference year: 2015
df_reg <- within(df_reg, Year <- relevel(Year, ref = '2015'))
lcp_length_km_lmrob15 <- lm_robust(formula = LCP_Length_km ~ Year,
          data = df_reg,
          clusters = From_To,
          fixed_effects = ~From_To,
          se_type = 'stata')
summary(lcp_length_km_lmrob15)

####### CWD Distance #######
# Reference year: 2011
df_reg <- within(df_reg, Year <- relevel(Year, ref = '2011'))
CWD_lmrob <- lm_robust(formula = CW_Dist_km ~ Year,
          data = df_reg,
          clusters = From_To,
          fixed_effects = ~From_To,
          se_type = 'stata')
summary(CWD_lmrob)

# Reference year: 2015
df_reg <- within(df_reg, Year <- relevel(Year, ref = '2015'))
CWD_lmrob15 <- lm_robust(formula = CW_Dist_km ~ Year,
          data = df_reg,
          clusters = From_To,
          fixed_effects = ~From_To,
          se_type = 'stata')
summary(CWD_lmrob15)

####### CWD to Path Length Distance #######
# Reference year: 2011
df_reg <- within(df_reg, Year <- relevel(Year, ref = '2011'))
CWDtoLCP_lmrob <- lm_robust(formula = cwd_to_Path_Length_Ratio ~ Year,
          data = df_reg,
          clusters = From_To,
          fixed_effects = ~From_To,
          se_type = 'stata')
summary(CWDtoLCP_lmrob)

# Reference year: 2015
df_reg <- within(df_reg, Year <- relevel(Year, ref = '2015'))
CWDtoLCP_lmrob15 <- lm_robust(formula = cwd_to_Path_Length_Ratio ~ Year,
          data = df_reg,
          clusters = From_To,
          fixed_effects = ~From_To,
          se_type = 'stata')
summary(CWDtoLCP_lmrob15)


###### Effective Resistance ######
# Reference year: 2011
df_reg <- within(df_reg, Year <- relevel(Year, ref = '2011'))
ER_lmrob <- lm_robust(formula = Effective_Resistance ~ Year,
          data = df_reg,
          clusters = From_To,
          fixed_effects = ~From_To,
          se_type = 'stata')

# Matching coefs and SEs, but no intercept
summary(ER_lmrob)

# Reference year: 2015
df_reg <- within(df_reg, Year <- relevel(Year, ref = '2015'))
ER_lmrob15 <- lm_robust(formula = Effective_Resistance ~ Year,
          data = df_reg,
          clusters = From_To,
          fixed_effects = ~From_To,
          se_type = 'stata')
summary(ER_lmrob15)

```


## New DFs for paired t-tests (Ashley reshapes data and keeps in one table instead)
```{r new_dfs}

df_2011 <- read_csv("./Data/2_Analysis/LCP_CSV/LCP_2011_csv.csv") %>%
  select(Year,
         To_Core,
         From_Core,
         ER_2011=Effective_Resistance,
         CWD_2011=CW_Dist,
         CWDtoLCP_2011=cwd_to_Path_Length_Ratio) %>%
  mutate(From_To = as.factor(paste0(From_Core,"_",To_Core)),
         CWD_km_2011 = CWD_2011/1000)

df_2015 <- read_csv("./Data/2_Analysis/LCP_CSV/LCP_2015_csv.csv") %>%
    select(Year,
         To_Core,
         From_Core,
         ER_2015=Effective_Resistance,
         CWD_2015=CW_Dist,
         CWDtoLCP_2015=cwd_to_Path_Length_Ratio) %>%
  mutate(From_To = as.factor(paste0(From_Core,"_",To_Core)),
         CWD_km_2015 = CWD_2015/1000)

df_2017 <- read_csv("./Data/2_Analysis/LCP_CSV/LCP_2017_csv.csv") %>%
    select(Year,
         To_Core,
         From_Core,
         ER_2017=Effective_Resistance,
         CWD_2017=CW_Dist,
         CWDtoLCP_2017=cwd_to_Path_Length_Ratio) %>%
  mutate(From_To = as.factor(paste0(From_Core,"_",To_Core)),
         CWD_km_2017 = CWD_2017/1000)

df_ttests <- merge(df_2011,df_2015,by='From_To') %>%
  merge(.,df_2017,by="From_To") %>%
  select(1,5:8,12:15,19:22)

```

# Paired T.Tests
```{r paired_t_tests}

attach(df_ttests)
# names(df_ttests)
# Effective Resistance vs 2011
t.test(ER_2011,ER_2015,paired = TRUE)
t.test(ER_2011,ER_2017,paired = TRUE)
t.test(ER_2015,ER_2017,paired = TRUE)

# CWD
t.test(CWD_km_2011,CWD_km_2015,paired = TRUE)
t.test(CWD_km_2011,CWD_km_2017,paired = TRUE)
t.test(CWD_km_2015,CWD_km_2017,paired = TRUE)

# LCP to CWD
t.test(CWDtoLCP_2011,CWDtoLCP_2015,paired = TRUE)
t.test(CWDtoLCP_2011,CWDtoLCP_2017,paired = TRUE)
t.test(CWDtoLCP_2015,CWDtoLCP_2017,paired = TRUE)
detach(df_ttests)
```

# Example results comparison: Within estimator regression versus T.tests on same sample with LCP to CWD ratio as outcome variable
```{r Ttest_reg_comparison}

# Subset regression dataset to only include paths that are also in the df_ttests set of From_To paths
df_reg_2 <- filter(df_reg,From_To %in% df_ttests$From_To)

# T.test
df_reg_2 <- within(df_reg_2, Year <- relevel(Year, ref = '2015'))
CWDtoLCP_lmrob <- lm_robust(formula = cwd_to_Path_Length_Ratio ~ Year,
          data = df_reg_2,
          clusters = From_To,
          fixed_effects = ~From_To,
          se_type = 'stata')
summary(CWDtoLCP_lmrob)

t.test(df_ttests$CWDtoLCP_2011,df_ttests$CWDtoLCP_2015,paired = TRUE)
t.test(df_ttests$CWDtoLCP_2011,df_ttests$CWDtoLCP_2017,paired = TRUE)
t.test(df_ttests$CWDtoLCP_2015,df_ttests$CWDtoLCP_2017,paired = TRUE)
```


